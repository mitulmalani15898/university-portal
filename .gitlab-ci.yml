image: java-latest

stages:
  - build
  - test
  - package
  - deploy

build:
  stage: build
  tags:
    - ugrad
  script:
    - "mvn compile"

test:
  stage: test
  tags:
    - ugrad
  script:
    - "mvn clean test"
  artifacts:
    paths:
      - "./target/surefire-reports/TEST-*.xml"
    reports:
      junit:
        - "./target/surefire-reports/TEST-*.xml"

package:
  stage: package
  tags:
    - ugrad
  script:
    - "mvn package"
  artifacts:
    when: on_success
    paths:
      - target/*.jar

deploy:
  stage: deploy
  image: ruby:latest
  tags:
    - ugrad
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_KEY" | tr -d '\r' | ssh-add -
  script:
    - ssh -o StrictHostKeyChecking=no manikandan@timberlea.cs.dal.ca "mkdir project/${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}"
    - scp -r -o StrictHostKeyChecking=no target/group-9-1.0.0.jar "manikandan@timberlea.cs.dal.ca:project/${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}/group-9-1.0.0.jar"
